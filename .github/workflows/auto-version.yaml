name: Auto Versioning ğŸš€

on:
  push:                  # ğŸ” Trigger workflow on push...
    branches-ignore:     # â›” ...except these branches
      - main
      - development
  workflow_dispatch:     # ğŸ› ï¸ Allow manual workflow trigger


permissions:
  contents: write  # âœï¸ Permission to push commits back to the repo

jobs:
  update-version:
    runs-on: ubuntu-latest  # ğŸ§ Use latest Ubuntu runner

    steps:
      - name: Checkout repository ğŸ§¾
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ğŸ“œ Fetch full commit history for accurate counts

      - name: Set up Git config ğŸ› ï¸
        run: |
          git config --global user.name "github-actions"      # ğŸ¤– Use bot name
          git config --global user.email "github-actions@github.com"  # ğŸ¤– Use bot email

      - name: Generate version number âœ¨
        id: generate_version
        run: |
          #Generate Version number
          
          # Fetch tags
          git fetch --tags
          # Get latest tag starting with 'v' (sorted by version semver)
          LATEST_TAG=$(git tag --list 'v*' --sort=-v:refname | head -n 1)

          # Extract the first digit after the 'v'
          if [[ $LATEST_TAG =~ ^v([0-9]) ]]; then
            MAJOR_VERSION="${BASH_REMATCH[1]}"
          else
            MAJOR_VERSION=0  # fallback if no matching tag found
          fi

          # ğŸ”¢ Count total commits in repo (used for minor & patch version)
          TOTAL_COMMITS=$(git rev-list --count origin/development)
          
          # ğŸ”¢ Calculate MINOR_VERSION by hundreds of commits (e.g., 117 commits = 1)
          MINOR_VERSION=$(( TOTAL_COMMITS / 100 ))
          
          # ğŸ”¢ Calculate PATCH_VERSION as remainder commits after hundreds (e.g., 117 commits = 17)
          PATCH_VERSION=$(( TOTAL_COMMITS % 100 ))
          
          # ğŸŒ¿ Base branch to compare against for branch-specific commit count
          BASE_BRANCH="origin/development"
          
          # ğŸ”¢ Count commits made on current branch since base branch (for build number)
          BRANCH_COMMITS=$(git rev-list --count $BASE_BRANCH..HEAD || echo 0)
          
          # ğŸ·ï¸ Compose full version string vMAJOR.MINOR.PATCH.BUILD
          VERSION="$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION.$BRANCH_COMMITS"

          # ğŸ“ Write version string to version.txt file
          echo "$VERSION" > app/src/main/assets/version.txt
          
          # âš™ï¸ Export version string to workflow environment variables
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Commit and push version.txt ğŸ’¾
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ğŸ” Use GitHub token for authentication
        run: |
          # ğŸ”§ Setup remote URL with token for push access
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}
          
          # â• Stage the updated version.txt file
          git add app/src/main/assets/version.txt
          
          # ğŸ’¬ Commit the change or skip if no changes
          git commit -m "chore: update version to $VERSION ğŸš€" || echo "No changes to commit"
          
          # ğŸ“¤ Push commit back to the current branch
          git push
